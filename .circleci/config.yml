---
version: 2.1
orbs:
  docker-publish: circleci/docker-publish@0.1.4
jobs:
  eclint:
    docker:
      - image: qima/eclint:circleci-2.8.1-7c65341
    steps:
      - checkout
      - run:
          name: Validate Editor Config rules
          command: |
            set -x
            ls -l
            git ls-files
            eclint check $(git ls-files)
  python-checks:
    docker:
      - image: circleci/python:3.7.2-stretch-node
    steps:
      - checkout
      - run:
          name: Install requirements
          command: |
            set -x
            pip install --user pylama
      - run:
          name: Check python style
          command: |
            set -x
            export PATH=$PATH:/home/circleci/.local/bin
            make python-checks

  python2-publish:
    docker:
      - image: circleci/python:2.7.15-stretch-node
    steps:
      - checkout
      - run:
          name: Install requirements
          command: |
            set -x
            pip install --user -r requirements_dev.txt
      - run:
          name: Publish
          command: |
            set -x
            export PATH=$PATH:/home/circleci/.local/bin
            echo -n $PYPIRC_B64 | base64 --decode > ~/.pypirc
            make clean dist-py2 dist-check-py2 dist-upload
            rm ~/.pypirc

  python3-publish:
    docker:
      - image: circleci/python:3.7.2-stretch-node
    steps:
      - checkout
      - run:
          name: Install requirements
          command: |
            set -x
            pip install --user -r requirements_dev.txt
      - run:
          name: Publish
          command: |
            set -x
            export PATH=$PATH:/home/circleci/.local/bin
            echo -n $PYPIRC_B64 | base64 --decode > ~/.pypirc
            make clean dist-py3 dist-check-py3 dist-upload
            rm ~/.pypirc

  wait-for-pypi-cache-update:
    docker:
      - image: circleci/python:3.7.2-stretch-node
    steps:
      - checkout
      - run:
          name: Check if package is available
          command: |
            set -x
            yamkix_version=$(make print-version)
            while true; do
              pip search yamkix | grep $yamkix_version
              if [ $? -eq "0" ]; then
                echo "Found expected version [$yamkix_version]"
                break;
              else
                echo "Did not find the expected version [$yamkix_version], sleeping"
                sleep 15s
              fi
            done

  docker-build-and-push:
    docker:
      - image: circleci/golang:1.11.5-stretch-node
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Build Exec Image
          command: |
            set -x
            docker version
            echo "Sleep for 30s to let pypi update its cache"
            sleep 30s
            make build
      - run:
          name: Build CircleCI compatible image
          command: |
            set -x
            docker version
            make build-circleci
      - docker-publish/check
      - run:
          name: Push Exec Image
          command: |
            set -x
            make push push-latest
      - run:
          name: Push CircleCI compatible image
          command: |
            set -x
            make push-circleci push-circleci-latest

workflows:
  version: 2
  workflow:
    jobs:
      - eclint
      - python-checks:
          requires:
            - eclint
      - python3-publish:
          requires:
            - python-checks
          filters:
            branches:
              only:
                - master
      - python2-publish:
          requires:
            - python-checks
          filters:
            branches:
              only:
                - master
      - wait-for-pypi-cache-update:
          requires:
            - python3-publish
            - python2-publish
          filters:
            branches:
              only:
                - master
      - docker-build-and-push:
          requires:
            - wait-for-pypi-cache-update
          filters:
            branches:
              only:
                - master
